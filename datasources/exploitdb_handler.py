import csv

from handlers import utils
from handlers.config_handler import ConfigHandler
from handlers.logger_handler import Logger
from handlers.mongodb_handler import MongodbHandler

def singleton(cls):
    instances = {}

    def get_instance(*args, **kwargs):
        if cls not in instances:
            instances[cls] = cls(*args, **kwargs)
        return instances[cls]

    return get_instance

@singleton
class ExploitdbHandler:

    def __init__(self, config_file='configuration.ini'):
        self.banner = f"{chr(int('EAD3', 16))} {chr(int('eaaf', 16))} Exploit-DB"
        config_handler = ConfigHandler(config_file)

        exploitdb_config = config_handler.get_exploitdb_config()
        self.url = exploitdb_config.get('url', 'https://gitlab.com/exploit-database/exploitdb/-/raw/main/files_exploits.csv?ref_type=heads')
        self.save_data = config_handler.get_boolean('cvemate', 'save_data', False)

        mongodb_config = config_handler.get_mongodb_config()
        self.mongodb_handler = MongodbHandler(
            mongodb_config['host'],
            mongodb_config['port'],
            mongodb_config['db'],
            mongodb_config['username'],
            mongodb_config['password'],
            mongodb_config['authdb'],
            mongodb_config['prefix'])

    def update(self):
        print('\n'+self.banner)

        # Call the new download_file method
        csv_data = utils.download_file(self.url, 'data/exploitdb.csv' if self.save_data else None)

        # Log the number of exploits and size of the file
        num_exploits = len(csv_data.splitlines()) - 1  # Subtract 1 for the header row
        file_size = len(csv_data.encode('utf-8'))  # Size in bytes
        Logger.log(f"[{chr(int('eaaf', 16))} Exploit-DB] Downloaded {num_exploits} exploits, file size: {file_size} bytes", 'INFO')

        # Initialize an empty list for the results
        results = []

        # Initialize a counter for CVE codes
        cve_count = 0

        # Process the CSV data
        lines = csv_data.splitlines()
        reader = csv.DictReader(lines)
        for row in reader:
            codes = row.get('codes', '').split(';')
            for code in codes:
                if code.startswith('CVE-'):
                    # Exclude the 'codes' column and add the data to the results
                    row_copy = row.copy()
                    row_copy.pop('codes', None)
                    results.append({'id': code, 'data': {'exploitdb': row_copy}})
                    Logger.log(f"[{chr(int('eaaf', 16))} Exploit-DB] CVE code {code} found for id {row['id']}. Corresponding data:\n{row_copy}", 'DEBUG')
                    cve_count += 1

        # Log the number of CVE codes found
        Logger.log(f"[{chr(int('eaaf', 16))} Exploit-DB] Total number of CVE codes found: {cve_count}", 'INFO')

        self.mongodb_handler.update_multiple_documents('cve', results)
        self.mongodb_handler.update_status('exploit-db')
        return results
